name: "Restore and save Nix store"
description: "Restore and save Nix store using GitHub Actions cache to speed up workflows."
author: "GitHub"
inputs:
  primary-key:
    description: |
      - When a non-empty string, the action uses this key for restoring and saving a cache.
      - Otherwise, the action fails.
    required: true
  
  prefixes-first-match:
    description: |
      - When a newline-separated non-empty list of non-empty key prefixes, when there's a miss on the `primary-key`, 
        the action searches in this list for the first prefix for which there exists a cache 
        with a matching key and the action tries to restore that cache.
      - Otherwise, this input has no effect.
    default: ""

  prefixes-all-matches:
    description: |
      - When a newline-separated non-empty list of non-empty key prefixes, the action tries to restore 
        all caches whose keys match these prefixes.
      - Otherwise, this input has no effect.
    default: ""

  skip-restore-on-primary-key-hit:
    description: |
      - Can have an effect only when `prefixes-first-match` has no effect.
      - When `true`, when there's a hit on the `primary-key`, the action doesn't restore caches.
      - Otherwise, this input has no effect.
    default: "false"

  fail-on:
    description: |
      - Input form: `<key type>.<result>`.
      - `<key type>` options: `primary`, `first-match`.
      - `<result>` options: `miss`, `not-restored`.
      - When the input satisfies the input form, when the event described in the input happens, the action fails.
      - Example:
        - Input: `primary.not-restored`.
        - Event: a cache could not be restored via the `primary-key`.

  paths:
    description: |
      - When a newline-separated non-empty list of non-empty path patterns (see [`@actions/glob`](https://github.com/actions/toolkit/tree/main/packages/glob) for supported patterns), the action appends it to [`/nix`, `~/.cache/nix`, `~root/.cache/nix`] and uses the resulting list for restoring and saving caches.
      - Otherwise, the action uses [`/nix`, `~/.cache/nix`, `~root/.cache/nix`] for restoring and saving caches.
    default: ""
  paths-macos:
    description: |
      - Overrides `paths`.
      - Can have an effect only when on a `macOS` runner.
      - When a newline-separated non-empty list of non-empty path patterns (see [`@actions/glob`](https://github.com/actions/toolkit/tree/main/packages/glob) for supported patterns), the action appends it to [`/nix`, `~/.cache/nix`, `~root/.cache/nix`] and uses the resulting list for restoring and saving caches.
      - Otherwise, the action uses [`/nix`, `~/.cache/nix`, `~root/.cache/nix`] for restoring and saving caches.
    default: ""
  paths-linux:
    description: |
      - Overrides `paths`.
      - Can have an effect only when on a `Linux` runner.
      - When a newline-separated non-empty list of non-empty path patterns (see [`@actions/glob`](https://github.com/actions/toolkit/tree/main/packages/glob) for supported patterns), the action appends it to [`/nix`, `~/.cache/nix`, `~root/.cache/nix`] and uses the resulting list for restoring and saving caches.
      - Otherwise, the action uses [`/nix`, `~/.cache/nix`, `~root/.cache/nix`] for restoring and saving caches.
    default: ""

  gc-max-store-size:
    description: |
      - When a number, the action collects garbage until Nix store size (in bytes) is at most this number just before trying to save a new cache.
      - Otherwise, this input has no effect.
    default: ""
  gc-max-store-size-macos:
    description: |
      - Overrides `gc-max-store-size`.
      - Can have an effect only when on a `macOS` runner.
      - When a number, the action collects garbage until Nix store size (in bytes) is at most this number just before trying to save a new cache.
      - Otherwise, this input has no effect.
    default: ""
  gc-max-store-size-linux:
    description: |
      - Overrides `gc-max-store-size`.
      - Can have an effect only when on a `Linux` runner.
      - When a number, the action collects garbage until Nix store size (in bytes) is at most this number just before trying to save a new cache.
      - Otherwise, this input has no effect.
    default: ""

  purge:
    description: |
      - When `true`, the action purges (possibly zero) old caches.
      - Otherwise, this input has no effect.
    default: "false"
  purge-overwrite:
    description: |
      - Can have an effect only when `purge` has effect.
      - When `always`, the action always purges old cache(s) with the `primary-key` and saves a new cache with the `primary-key`.
      - When `never`, the action never purges old cache(s) with the `primary-key` and saves a new cache when there's a miss on the `primary-key`.
      - Otherwise, the action purges old caches using purging criteria and saves a new cache when there's a miss on the `primary-key`.
    default: ""
  purge-prefixes:
    description: |
      - Can have an effect only when `purge` has effect.
      - When a newline-separated non-empty list of non-empty cache key prefixes, the action collects for purging all cache keys that match these prefixes.
      - Otherwise, this input has no effect.
    default: ""
  purge-last-accessed:
    description: |
      - Can have an effect only when `purge-prefixes` has effect.
      - When a number, the action purges caches last accessed more than this number of seconds ago relative to the start of the Save phase.
      - Otherwise, this input has no effect.
    default: ""
  purge-created:
    description: |
      - Can have an effect only when `purge-prefixes` has effect.
      - When a number, the action purges caches created more than this number of seconds ago relative to the start of the Save phase.
      - Otherwise, this input has no effect.
    default: ""

  upload-chunk-size:
    # The original default value may be provided here (https://github.com/actions/cache/issues/1292)
    # 32MB
    description: |
      - When a number, the action uses it as the chunk size (in bytes) to split up large files during upload.
      - Otherwise, the action uses the default value `33554432` (32MB).
    default: ""

  token:
    description: The action uses it to communicate with GitHub API.
    default: ${{ github.token }}
outputs:
  primary-key:
    description: |
      - A string.
      - The `primary-key`.

  hit:
    description: |
      - A boolean value.
      - `true` when `hit-primary` is `true` or `hit-first-match` is `true`.
      - `false` otherwise.
  hit-primary:
    description: |
      - A boolean value.
      - `true` when there was a hit on the `primary-key`.
      - `false` otherwise.
  hit-first-match:
    description: |
      - A boolean value.
      - `true` when there was a hit on a key matching `prefixes-first-match`.
      - `false` otherwise.

  restored-key:
    description: |
      - A string.
      - The key of a cache restored via the `primary-key` or via the `prefixes-first-match`.
      - An empty string otherwise.

  restored-keys:
    description: |
      - A possibly empty array of strings (JSON).
      - Keys of restored caches.
      - Example: `["key1", "key2"]`.
runs:
  using: "node16"
  main: "dist/restore/index.js"
  post: "dist/save/index.js"
  post-if: success()
branding:
  icon: "archive"
  color: "gray-dark"
